-- [1] ê¸°ì¡´ êµ¬ì¡° ì´ˆê¸°í™” (ìƒˆë¡œ ì‹œì‘í•  ë•Œë¥¼ ëŒ€ë¹„)
DROP TRIGGER IF EXISTS on_auth_user_created ON auth.users;
DROP FUNCTION IF EXISTS public.handle_new_user();
DROP TABLE IF EXISTS public.survey_responses;
DROP TABLE IF EXISTS public.profiles;

-- [2] profiles í…Œì´ë¸” ìƒì„± (ì‚¬ìš©ì ì •ë³´)
-- ê°€ì… ì‹œ ìœ ì—°í•¨ì„ ìœ„í•´ nameê³¼ emailì˜ NOT NULL ì œì•½ì„ í•´ì œí•œ ìµœì‹  ë²„ì „ì…ë‹ˆë‹¤.
CREATE TABLE public.profiles (
  id UUID REFERENCES auth.users ON DELETE CASCADE PRIMARY KEY,
  email TEXT UNIQUE,
  name TEXT,
  created_at TIMESTAMPTZ DEFAULT NOW() NOT NULL
);

-- [3] survey_responses í…Œì´ë¸” ìƒì„± (ì„¤ë¬¸ ì‘ë‹µ)
CREATE TABLE public.survey_responses (
  id BIGINT GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
  user_id UUID REFERENCES public.profiles(id) ON DELETE CASCADE NOT NULL,
  q1 TEXT NOT NULL,
  q2 TEXT[] NOT NULL,
  q3 TEXT NOT NULL,
  q4 TEXT[] NOT NULL,
  q5 TEXT, -- ì„œìˆ í˜• ë¬¸í•­
  created_at TIMESTAMPTZ DEFAULT NOW() NOT NULL
);

-- [4] RLS(ë³´ì•ˆ ì •ì±…) í™œì„±í™”
ALTER TABLE public.profiles ENABLE ROW LEVEL SECURITY;
ALTER TABLE public.survey_responses ENABLE ROW LEVEL SECURITY;

-- [5] profiles í…Œì´ë¸” ë³´ì•ˆ ì •ì±…
-- ê°€ì… ì‹œ ì„¸ì…˜ì´ ì—†ëŠ” ìƒíƒœì—ì„œë„ í”„ë¡œí•„ ìƒì„±ì´ ê°€ëŠ¥í•˜ë„ë¡ í—ˆìš© (500 ì—ëŸ¬ ë°©ì§€)
CREATE POLICY "Allow all inserts for signup" 
ON public.profiles FOR INSERT 
WITH CHECK (true);

CREATE POLICY "Allow all selects for app" 
ON public.profiles FOR SELECT 
USING (true);

-- [6] survey_responses í…Œì´ë¸” ë³´ì•ˆ ì •ì±…
-- ë³¸ì¸ì˜ ì‘ë‹µë§Œ ì €ì¥í•˜ê³  ë³¸ì¸ì˜ ì‘ë‹µë§Œ ë³¼ ìˆ˜ ìˆë„ë¡ ì„¤ì •
CREATE POLICY "Users can insert their own responses" 
ON public.survey_responses FOR INSERT 
WITH CHECK (auth.uid() = user_id);

CREATE POLICY "Users can view their own responses" 
ON public.survey_responses FOR SELECT 
USING (auth.uid() = user_id);

-- [7] ê´€ë¦¬ì ì „ìš© ì •ì±… (ì„ íƒ ì‚¬í•­)
-- ë³¸ì¸ì˜ ê´€ë¦¬ì ì´ë©”ì¼ì„ ì •í™•íˆ ì…ë ¥í•˜ì„¸ìš”.
CREATE POLICY "Admins can view everything" 
ON public.survey_responses FOR SELECT 
USING (auth.jwt() ->> 'email' = 'your-admin-email@example.com');



-- -- âš ï¸ ì„¸íŒ… ì‹œ ì£¼ì˜ì‚¬í•­ (Dashboard ì„¤ì •)
-- -- SQL ì‹¤í–‰ ì™¸ì— Supabase ëŒ€ì‹œë³´ë“œì—ì„œ ë°˜ë“œì‹œ ì•„ë˜ ì„¤ì •ì„ ìˆ˜ë™ìœ¼ë¡œ ë³€ê²½í•´ì•¼ ì•±ì´ ì •ìƒ ì‘ë™í•©ë‹ˆë‹¤:
-- -- Email Confirmation ë¹„í™œì„±í™”:
-- -- Authentication -> Providers -> Email -> Confirm emailì„ OFFë¡œ ì„¤ì •.
-- -- ì´ê²Œ ì¼œì ¸ ìˆìœ¼ë©´ ê°€ì… ì¦‰ì‹œ ë¡œê·¸ì¸ì´ ì•ˆ ë˜ì–´ ì„¤ë¬¸ ì‘ì„±ì´ ë¶ˆê°€ëŠ¥í•´ì§‘ë‹ˆë‹¤.
-- -- í™˜ê²½ ë³€ìˆ˜(Vite):
-- -- ë°˜ë“œì‹œ eyJ...ë¡œ ì‹œì‘í•˜ëŠ” ê¸´ Anon Keyë¥¼ ì‚¬ìš©í•˜ì„¸ìš”.


-- ğŸ’¡ íŒ: ë°ì´í„° ì´ˆê¸°í™”ê°€ í•„ìš”í•  ë•Œ
-- ê°œë°œ ì¤‘ì— ëª¨ë“  ìœ ì €ì™€ ë°ì´í„°ë¥¼ ë°€ê³  ë‹¤ì‹œ ì‹œì‘í•˜ê³  ì‹¶ë‹¤ë©´ ì•„ë˜ ëª…ë ¹ë§Œ ì‹¤í–‰í•˜ë©´ ë©ë‹ˆë‹¤.

-- -- SQL
-- --   TRUNCATE public.survey_responses CASCADE;
-- --   TRUNCATE public.profiles CASCADE;
-- --   DELETE FROM auth.users;








-- ê¸°ì¡´ì˜ ì œí•œì ì¸ SELECT ì •ì±…ì„ ì‚­ì œí•©ë‹ˆë‹¤.
DROP POLICY IF EXISTS "Users can view their own responses" ON public.survey_responses;
DROP POLICY IF EXISTS "Admins can view everything" ON public.survey_responses;

-- ëª¨ë“  ì¸ì¦ëœ ì‚¬ìš©ìê°€ ëª¨ë“  ì‘ë‹µì„ ë³¼ ìˆ˜ ìˆë„ë¡ í—ˆìš© (ê´€ë¦¬ì ì „ìš© í˜ì´ì§€ì´ë¯€ë¡œ)
CREATE POLICY "Enable read access for all authenticated users" 
ON public.survey_responses FOR SELECT 
TO authenticated 
USING (true);


-- ê¸°ì¡´ì˜ ì‚­ì œ ì •ì±…ì´ ìˆë‹¤ë©´ ì‚­ì œ
DROP POLICY IF EXISTS "Enable delete for authenticated users" ON public.survey_responses;

-- ëª¨ë“  ì¸ì¦ëœ ì‚¬ìš©ìê°€ ì„¤ë¬¸ ì‘ë‹µì„ ì‚­ì œí•  ìˆ˜ ìˆë„ë¡ í—ˆìš©
-- (ë” ë³´ì•ˆì„ ê°•í™”í•˜ë ¤ë©´ íŠ¹ì • ê´€ë¦¬ì ì´ë©”ì¼ ì¡°ê±´ 'auth.jwt() ->> email = ...'ì„ ë„£ì„ ìˆ˜ ìˆìŠµë‹ˆë‹¤)
CREATE POLICY "Enable delete for authenticated users"
ON public.survey_responses
FOR DELETE
TO authenticated
USING (true);